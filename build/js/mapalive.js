/*! project5 2015-10-09 */
var locations=[{name:"DEBELI RTIČ",coordinates:[45.5904856,13.7021026],description:"it being on the other side of the bay, makes for an uncommon view",activities:["swimming"]},{name:"DRAGONJA",coordinates:[45.45104,13.692053],description:"river waters, fresh valley, saw a snake eat a fish once",activities:["swimming","walking","biking"]},{name:"PIRAN",coordinates:[45.530337,13.562947],description:"looks nice from above, and from the sea, and theres plenty of both",activities:["swimming","diving","walking"]},{name:"SAVUDRIJA",coordinates:[45.5,13.504],description:": )",activities:["swimming","diving","walking","biking"]},{name:"SEČA",coordinates:[45.501301,13.587052],description:"there is a playground for adults here, swims also decent",activities:["swimming","walking","biking"]},{name:"SOLINE",coordinates:[45.490521,13.601933],description:"great scenery, salt used to be the real deal some time ago",activities:["swimming","walking","biking"]},{name:"STRUGNANO",coordinates:[45.537589,13.618552],description:"Sweet round hill, with endless views and wind, and cliffs looking like big rock whales",activities:["swimming","walking"]},{name:"STRUNJAN",coordinates:[45.528669,13.608685],description:"there is a cute line of trees if you zoom in, walk sweet, up on the hills or by the sea",activities:["walking","biking"]}],map,errorMessage,initMap=function(){if(void 0!==google){map=new google.maps.Map(document.getElementById("map"),{mapTypeId:google.maps.MapTypeId.HYBRID,mapTypeControl:!1});var bounds=new google.maps.LatLngBounds;locations.forEach(function(location){var latlngBound=new google.maps.LatLng(location.coordinates[0],location.coordinates[1]);bounds.extend(latlngBound)}),map.fitBounds(bounds)}else errorMessage=!0};initMap();var currentWeather,getWeather=function(){var weatherPlace="piran",locationQuery=escape("select item.condition from weather.forecast where woeid in (select woeid from geo.places(1) where text='"+weatherPlace+"') and u='c'"),weatherAPI="http://query.yahooapis.com/v1/public/yql?q="+locationQuery+"&format=json&callback=?";$.getJSON(weatherAPI).done(function(data){currentWeather=data.query.results.channel.item.condition,getWeatherInfo(currentWeather)}).fail(function(){console.log("no weather")})};getWeather();var refreshPhotos=function(){var flickerAPI="https://api.flickr.com/services/rest/?&method=flickr.photos.search&api_key=475b3ad500b92ed51c6657bb3ebd262e&jsoncallback=?";$.getJSON(flickerAPI,{tags:photoSearch,format:"json",text:"-woman, -man, -portrait, -wedding, -esuli, -car, -people, -pirat",tag_mode:"all"}).done(function(data){jsonFlickrApi(data)}).fail(function(d,textStatus,error){errorMessage=!0,console.error("getJSON failed, status: "+textStatus+", error: "+error)})},Place=function(data){this.name=data.name,this.coordinates=data.coordinates,this.description=data.description,this.activities=data.activities,this.latlng=new google.maps.LatLng(this.coordinates[0],this.coordinates[1]),this.marker=new google.maps.Marker({position:this.latlng,title:this.name,icon:"img/sea.png"})},locationsToUse,photoSearch="istria",ViewModel=function(){var self=this;self.locationsArray=ko.observableArray([]),locations.forEach(function(place){self.locationsArray.push(new Place(place))}),self.visibleLocations=ko.observableArray([]),self.userInput=ko.observable(""),self.displayMessage=ko.observable(!1);var search="";self.showLocations=function(location){return photoSearch="",self.visibleLocations.removeAll(),locationsArray().forEach(function(place){place.name.toLowerCase().indexOf(location)>-1||place.description.indexOf(location)>-1?(self.visibleLocations.push(place),place.marker.setMap(map),photoSearch+=place.name+", "):-1===place.name.toLowerCase().indexOf(location.toLowerCase())&&place.marker.setMap(null)}),visibleLocations().length===locations.length?(self.displayMessage(!1),photoSearch="istrien"):0===visibleLocations().length&&(photoSearch="istria"),visibleLocations()},refreshPhotos(),locationsToUse=self.showLocations(search),self.availableLocations=function(){search=self.userInput().toLowerCase(),self.displayMessage(!0),showLocations(search),refreshPhotos()},self.locationClick=function(location){search=location.name.toLowerCase(),showLocations(search),photoSearch=location.name,self.displayMessage(!0),refreshPhotos()},self.refreshClick=function(){search="",self.userInput(""),infoWindow.close(),showLocations(search),refreshPhotos()},self.visibleActivity=ko.observable([!0,!0,!0,!0]),self.chooseActivity=function(activity,order){self.visibleLocations.removeAll(),locationsArray().forEach(function(place){place.activities.indexOf(activity)>-1?(self.visibleLocations.push(place),place.marker.setMap(map)):-1===place.activities.indexOf(activity)&&place.marker.setMap(null)});var visibility=[!1,!1,!1,!1];visibility[order]=!0,self.visibleActivity(visibility),self.visibleActivity()[order]=!0,self.displayMessage(!0),photoSearch="istria, "+activity,refreshPhotos()},self.wheaterImage=ko.observable(""),self.wheaterTemperature=ko.observable(""),self.getWeatherInfo=function(currentWeather){self.wheaterImage("http://l.yimg.com/a/i/us/we/52/"+currentWeather.code+".gif"),self.wheaterTemperature(currentWeather.temp+"°C")},self.imagesArray=ko.observableArray([]),self.errorMessage=ko.observable(errorMessage),self.jsonFlickrApi=function(info){void 0!==info.photos?(self.imagesArray([]),info.photos.photo.forEach(function(data){self.imagesArray.push(["https://www.flickr.com/photos/"+data.owner+"/"+data.id,"http://farm"+data.farm+".static.flickr.com/"+data.server+"/"+data.id+"_"+data.secret+"_m.jpg","Flickr photo search keyword: "+photoSearch])})):self.errorMessage(!0)}};ko.applyBindings(ViewModel());var infoWindow,makeInfoWindow=function(){infoWindow=new google.maps.InfoWindow({maxWidth:150}),locationsToUse.forEach(function(place){google.maps.event.addListener(place.marker,"click",function(loc){return function(){infoWindow.setContent("<h4>"+loc.name+"</h4> <p>"+loc.description+"</p>"),infoWindow.open(map,this),photoSearch=loc.name,displayMessage(!0),refreshPhotos(),place.marker.setMap(null),place.marker.setAnimation(google.maps.Animation.DROP),place.marker.setMap(map),map.setCenter(place.marker.getPosition())}}(place))})};makeInfoWindow();