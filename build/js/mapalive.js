/*! project5 2015-10-18 */
"use strict";function startAll(){initMap(),vm=new ViewModel,ko.applyBindings(vm),makeInfoWindow()}var locations=[{name:"DEBELI RTIČ",coordinates:[45.5904856,13.7021026],description:"it being on the other side of the bay, makes for an uncommon view",activities:["swimming"]},{name:"DRAGONJA",coordinates:[45.45104,13.692053],description:"river waters, fresh valley, saw a snake eat a fish once",activities:["swimming","walking","biking"]},{name:"PIRAN",coordinates:[45.530337,13.562947],description:"looks nice from above, and from the sea, and there is plenty of both",activities:["swimming","diving","walking"]},{name:"SAVUDRIJA",coordinates:[45.5,13.504],description:": )",activities:["swimming","diving","walking","biking"]},{name:"SEČA",coordinates:[45.501301,13.587052],description:"there is a playground for adults here, swims also decent",activities:["swimming","walking","biking"]},{name:"SOLINE",coordinates:[45.490521,13.601933],description:"great scenery, salt used to be the real deal some time ago",activities:["swimming","walking","biking"]},{name:"STRUGNANO",coordinates:[45.537589,13.618552],description:"sweet round hill, with endless views and wind, and cliffs looking like big rock whales",activities:["swimming","walking"]},{name:"STRUNJAN",coordinates:[45.528669,13.608685],description:"there is a cute line of trees if you zoom in, walk sweet, up on the hills or by the sea",activities:["walking","biking"]}],map,bounds,initMap=function(){void 0!==google&&(map=new google.maps.Map(document.getElementById("map"),{mapTypeId:google.maps.MapTypeId.HYBRID,mapTypeControl:!1}),bounds=new google.maps.LatLngBounds,locations.forEach(function(location){var latlngBound=new google.maps.LatLng(location.coordinates[0],location.coordinates[1]);bounds.extend(latlngBound)}),map.fitBounds(bounds))},Place=function(data){this.name=data.name,this.coordinates=data.coordinates,this.description=data.description,this.activities=data.activities,this.latlng=new google.maps.LatLng(this.coordinates[0],this.coordinates[1]),this.marker=new google.maps.Marker({position:this.latlng,title:this.name,icon:"img/sea.png"})},photoSearch="istria",ViewModel=function(){var self=this;self.locationsToUse=ko.observableArray(),self.locationsArray=ko.observableArray([]),locations.forEach(function(place){self.locationsArray.push(new Place(place))});var currentWeather;self.getWeather=function(){var weatherPlace="piran",locationQuery=escape("select item.condition from weather.forecast where woeid in (select woeid from geo.places(1) where text='"+weatherPlace+"') and u='c'"),weatherAPI="http://query.yahooapis.com/v1/public/yql?q="+locationQuery+"&format=json&callback=?";$.getJSON(weatherAPI).done(function(data){currentWeather=data.query.results.channel.item.condition,self.getWeatherInfo(currentWeather)}).fail(function(){self.getWeatherInfo({code:"3200",temp:"??"})})},self.visibleLocations=ko.observableArray([]),self.userInput=ko.observable(""),self.refreshMessage=ko.observable(!1),self.visibleActivity=ko.observable([!0,!0,!0,!0]);var search="";self.showLocations=function(location){return photoSearch="",self.visibleLocations.removeAll(),self.locationsArray().forEach(function(place){place.name.toLowerCase().indexOf(location)>-1||place.description.indexOf(location)>-1?(self.visibleLocations.push(place),place.marker.icon="img/sea.png",place.marker.setMap(map),photoSearch=place.name):-1===place.name.toLowerCase().indexOf(location.toLowerCase())&&place.marker.setMap(null)}),self.visibleLocations().length===locations.length?(self.refreshMessage(!1),photoSearch="istra"):0===self.visibleLocations().length&&(photoSearch="istria"),self.visibleLocations()},self.showList=ko.observable(!0),self.toggleVisibility=function(){self.showList(!self.showList())},self.refreshPhotos=function(){var flickerAPI="https://api.flickr.com/services/rest/?&method=flickr.photos.search&api_key=475b3ad500b92ed51c6657bb3ebd262e&jsoncallback=?";$.getJSON(flickerAPI,{tags:photoSearch,format:"json",text:"-woman, -man, -portrait, -wedding, -esuli, -car, -people, -pirat, -dubrovačkoneretvanskažupanija, -dubrovnik",tag_mode:"all"}).done(function(data){var image=data.photos.photo[0];self.photo=ko.observable("http://farm"+image.farm+".static.flickr.com/"+image.server+"/"+image.id+"_"+image.secret+"_m.jpg"),self.jsonFlickrApi(data)}).fail(function(d,textStatus,error){self.photoErrorMessage(!0)})},self.locationsToUse(self.showLocations(search)),self.descriptionWords=ko.observableArray(),self.showWords=ko.observableArray();var allText="";self.locationsArray().forEach(function(place){allText+=place.description.replace(",","").split(" ")+","}),self.descriptionWords.push(allText.split(",")),self.availableLocations=function(){self.showWords(""),self.visibleActivity([!0,!0,!0,!0]),search=self.userInput().toLowerCase(),self.refreshMessage(!0),self.showLocations(search),self.refreshPhotos(),self.showWords([]),self.descriptionWords()[0].forEach(function(word){word.indexOf(search)>-1&&-1===self.showWords().indexOf(word)&&self.showWords.push(word)})},self.locationClick=function(location){self.visibleActivity([!0,!0,!0,!0]),search=location.name.toLowerCase(),self.showLocations(search),google.maps.event.trigger(location.marker,"click"),photoSearch=location.name,self.refreshMessage(!0),self.refreshPhotos()},self.refreshClick=function(){self.visibleActivity([!0,!0,!0,!0]),search="",self.showWords([]),self.userInput(""),infoWindow.close(),self.showLocations(search),self.refreshPhotos()},self.searchWord=function(word){self.userInput(word),self.availableLocations()},self.chooseActivity=function(activity,order){self.visibleLocations.removeAll(),self.locationsArray().forEach(function(place){place.activities.indexOf(activity)>-1?(self.visibleLocations.push(place),place.marker.icon="img/"+activity+".png",place.marker.setMap(map)):-1===place.activities.indexOf(activity)&&place.marker.setMap(null)});var visibility=[!1,!1,!1,!1];visibility[order]=!0,self.visibleActivity(visibility),self.refreshMessage(!0),photoSearch="istria, "+activity,self.refreshPhotos(),infoWindow.close(),map.fitBounds(bounds),self.userInput("")},self.wheaterImage=ko.observable(""),self.wheaterTemperature=ko.observable(""),self.getWeatherInfo=function(currentWeather){self.wheaterImage("http://l.yimg.com/a/i/us/we/52/"+currentWeather.code+".gif"),self.wheaterTemperature(currentWeather.temp+"°C")},self.photo=ko.observable(),self.imagesArray=ko.observableArray([]),self.photoErrorMessage=ko.observable(!1),self.jsonFlickrApi=function(info){void 0!==info.photos&&(self.imagesArray([]),info.photos.photo.forEach(function(data){self.imagesArray.push(["https://www.flickr.com/photos/"+data.owner+"/"+data.id,"http://farm"+data.farm+".static.flickr.com/"+data.server+"/"+data.id+"_"+data.secret+"_m.jpg","Flickr photo search keyword: "+photoSearch])}))},self.usersOnline=ko.observable(0),self.getUsers=function(){var listRef=new Firebase("https://blinding-fire-8036.firebaseio.com/presence/"),userRef=listRef.push(),presenceRef=new Firebase("https://blinding-fire-8036.firebaseio.com/.info/connected");presenceRef.on("value",function(snap){snap.val()&&(userRef.set(!0),userRef.onDisconnect().remove())}),listRef.on("value",function(snap){self.usersOnline(snap.numChildren())})},self.getUsers(),self.refreshPhotos(),self.getWeather()},vm,infoWindow,makeInfoWindow=function(){infoWindow=new google.maps.InfoWindow({maxWidth:150}),vm.locationsToUse().forEach(function(place){google.maps.event.addListener(place.marker,"click",function(){return function(){photoSearch=place.name,place.marker.setMap(null),place.marker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){place.marker.setAnimation(null)},1850),place.marker.setMap(map),map.setCenter(place.marker.getPosition()),vm.refreshMessage(!0),vm.refreshPhotos(),infoWindow.setContent("<h4>"+place.name+"</h4> <p>"+place.description+'<br><img  class="mini-img" alt="mini photo of place" src="'+vm.photo()+'">'),infoWindow.open(map,this)}}(place))})};